name: RDP Final Final Version

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Start RDP
        run: |
          # Download and extract Ngrok
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive "ngrok.zip"
          
          # Add Ngrok auth token
          ./ngrok.exe config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          
          # Enable RDP and create user
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user "runneradmin" "win-@12345" /add
          net localgroup "Administrators" "runneradmin" /add
          net localgroup "Remote Desktop Users" "runneradmin" /add
          
          # Start Ngrok tunnel in the background
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -NoNewWindow
          
          # Wait for Ngrok to start and get the URL
          Start-Sleep -Seconds 15
          $tunnel_info = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
          $tunnel_url = $tunnel_info.tunnels[0].public_url
          
          Write-Host "=========================================="
          Write-Host "RDP Address: $tunnel_url"
          Write-Host "Username:    runneradmin"
          Write-Host "Password:    win-@12345"
          Write-Host "=========================================="
          
          # Keep the workflow alive
          Start-Sleep -Seconds 36000
